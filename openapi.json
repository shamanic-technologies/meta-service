{
  "openapi": "3.0.0",
  "info": {
    "title": "Meta Service",
    "description": "Wraps the Meta (Facebook) Graph API v22.0 for ad account management, performance reporting, and organic posting.",
    "version": "1.0.0"
  },
  "servers": [
    {
      "url": "http://localhost:3001"
    }
  ],
  "components": {
    "securitySchemes": {
      "serviceKeyAuth": {
        "type": "apiKey",
        "in": "header",
        "name": "x-api-key",
        "description": "Service-to-service key (META_SERVICE_API_KEY)"
      }
    },
    "schemas": {
      "HealthResponse": {
        "type": "object",
        "properties": {
          "status": {
            "type": "string"
          },
          "timestamp": {
            "type": "string"
          },
          "service": {
            "type": "string"
          }
        },
        "required": [
          "status",
          "timestamp",
          "service"
        ]
      },
      "AuthorizeResponse": {
        "type": "object",
        "properties": {
          "authorizationUrl": {
            "type": "string",
            "format": "uri"
          }
        },
        "required": [
          "authorizationUrl"
        ]
      },
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "error": {
            "type": "string"
          },
          "details": {
            "nullable": true
          }
        },
        "required": [
          "error"
        ]
      },
      "MessageResponse": {
        "type": "object",
        "properties": {
          "message": {
            "type": "string"
          }
        },
        "required": [
          "message"
        ]
      },
      "ConnectionResponse": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "appId": {
            "type": "string"
          },
          "clerkOrgId": {
            "type": "string",
            "nullable": true
          },
          "label": {
            "type": "string",
            "nullable": true
          },
          "metaUserId": {
            "type": "string"
          },
          "metaUserName": {
            "type": "string",
            "nullable": true
          },
          "scopes": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "tokenExpiresAt": {
            "type": "string",
            "nullable": true,
            "format": "date-time"
          },
          "adAccounts": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/AdAccountSummary"
            }
          },
          "pages": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/PageSummary"
            }
          },
          "createdAt": {
            "type": "string",
            "format": "date-time"
          }
        },
        "required": [
          "id",
          "appId",
          "clerkOrgId",
          "label",
          "metaUserId",
          "metaUserName",
          "scopes",
          "tokenExpiresAt",
          "adAccounts",
          "pages",
          "createdAt"
        ]
      },
      "AdAccountSummary": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "adAccountId": {
            "type": "string"
          },
          "accountName": {
            "type": "string",
            "nullable": true
          },
          "currency": {
            "type": "string",
            "nullable": true
          },
          "timezone": {
            "type": "string",
            "nullable": true
          },
          "accountStatus": {
            "type": "number",
            "nullable": true
          },
          "isActive": {
            "type": "boolean"
          }
        },
        "required": [
          "id",
          "adAccountId",
          "accountName",
          "currency",
          "timezone",
          "accountStatus",
          "isActive"
        ]
      },
      "PageSummary": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "pageId": {
            "type": "string"
          },
          "pageName": {
            "type": "string",
            "nullable": true
          },
          "hasInstagram": {
            "type": "boolean"
          }
        },
        "required": [
          "id",
          "pageId",
          "pageName",
          "hasInstagram"
        ]
      },
      "AdAccountResponse": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "connectionId": {
            "type": "string",
            "format": "uuid"
          },
          "adAccountId": {
            "type": "string"
          },
          "accountName": {
            "type": "string",
            "nullable": true
          },
          "currency": {
            "type": "string",
            "nullable": true
          },
          "timezone": {
            "type": "string",
            "nullable": true
          },
          "accountStatus": {
            "type": "number",
            "nullable": true
          },
          "isActive": {
            "type": "boolean"
          },
          "createdAt": {
            "type": "string",
            "format": "date-time"
          },
          "updatedAt": {
            "type": "string",
            "format": "date-time"
          }
        },
        "required": [
          "id",
          "connectionId",
          "adAccountId",
          "accountName",
          "currency",
          "timezone",
          "accountStatus",
          "isActive",
          "createdAt",
          "updatedAt"
        ]
      },
      "PatchAccountBody": {
        "type": "object",
        "properties": {
          "isActive": {
            "type": "boolean"
          }
        },
        "required": [
          "isActive"
        ]
      },
      "InsightsResponse": {
        "type": "object",
        "properties": {
          "data": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/InsightRow"
            }
          },
          "paging": {
            "$ref": "#/components/schemas/Paging"
          }
        },
        "required": [
          "data"
        ]
      },
      "InsightRow": {
        "type": "object",
        "properties": {
          "campaignId": {
            "type": "string"
          },
          "campaignName": {
            "type": "string"
          },
          "adsetId": {
            "type": "string"
          },
          "adsetName": {
            "type": "string"
          },
          "adId": {
            "type": "string"
          },
          "adName": {
            "type": "string"
          },
          "dateStart": {
            "type": "string"
          },
          "dateStop": {
            "type": "string"
          },
          "impressions": {
            "type": "string"
          },
          "reach": {
            "type": "string"
          },
          "clicks": {
            "type": "string"
          },
          "spend": {
            "type": "string"
          },
          "cpc": {
            "type": "string"
          },
          "cpm": {
            "type": "string"
          },
          "ctr": {
            "type": "string"
          },
          "actions": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "actionType": {
                  "type": "string"
                },
                "value": {
                  "type": "string"
                }
              },
              "required": [
                "actionType",
                "value"
              ]
            }
          },
          "costPerActionType": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "actionType": {
                  "type": "string"
                },
                "value": {
                  "type": "string"
                }
              },
              "required": [
                "actionType",
                "value"
              ]
            }
          }
        },
        "required": [
          "dateStart",
          "dateStop",
          "impressions",
          "spend"
        ],
        "additionalProperties": {
          "nullable": true
        }
      },
      "Paging": {
        "type": "object",
        "properties": {
          "cursors": {
            "type": "object",
            "properties": {
              "before": {
                "type": "string"
              },
              "after": {
                "type": "string"
              }
            }
          },
          "next": {
            "type": "string"
          }
        }
      }
    },
    "parameters": {}
  },
  "paths": {
    "/health": {
      "get": {
        "summary": "Health check",
        "responses": {
          "200": {
            "description": "Service is healthy",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HealthResponse"
                }
              }
            }
          }
        }
      }
    },
    "/auth/meta/authorize": {
      "get": {
        "summary": "Generate Meta OAuth login URL",
        "security": [
          {
            "serviceKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "minLength": 1
            },
            "required": true,
            "name": "appId",
            "in": "query"
          },
          {
            "schema": {
              "type": "string"
            },
            "required": false,
            "name": "clerkOrgId",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "format": "uri"
            },
            "required": true,
            "name": "redirectUri",
            "in": "query"
          },
          {
            "schema": {
              "type": "string"
            },
            "required": false,
            "name": "label",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "OAuth authorization URL",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AuthorizeResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid request",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/auth/meta/callback": {
      "get": {
        "summary": "Handle Meta OAuth callback",
        "parameters": [
          {
            "schema": {
              "type": "string"
            },
            "required": true,
            "name": "code",
            "in": "query"
          },
          {
            "schema": {
              "type": "string"
            },
            "required": true,
            "name": "state",
            "in": "query"
          }
        ],
        "responses": {
          "302": {
            "description": "Redirect to app with connectionId"
          },
          "400": {
            "description": "Invalid callback",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/auth/meta/connections/{connectionId}": {
      "delete": {
        "summary": "Disconnect a Meta connection",
        "security": [
          {
            "serviceKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "format": "uuid"
            },
            "required": true,
            "name": "connectionId",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Connection removed",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/MessageResponse"
                }
              }
            }
          },
          "404": {
            "description": "Connection not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/connections": {
      "get": {
        "summary": "List Meta connections for an app/org",
        "security": [
          {
            "serviceKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "minLength": 1
            },
            "required": true,
            "name": "appId",
            "in": "query"
          },
          {
            "schema": {
              "type": "string"
            },
            "required": false,
            "name": "clerkOrgId",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "List of connections",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "connections": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/ConnectionResponse"
                      }
                    }
                  },
                  "required": [
                    "connections"
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Missing appId",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/accounts": {
      "get": {
        "summary": "List ad accounts across connections",
        "security": [
          {
            "serviceKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "minLength": 1
            },
            "required": true,
            "name": "appId",
            "in": "query"
          },
          {
            "schema": {
              "type": "string"
            },
            "required": false,
            "name": "clerkOrgId",
            "in": "query"
          },
          {
            "schema": {
              "type": "boolean",
              "nullable": true,
              "default": true
            },
            "required": false,
            "name": "activeOnly",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "List of ad accounts",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "accounts": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/AdAccountResponse"
                      }
                    }
                  },
                  "required": [
                    "accounts"
                  ]
                }
              }
            }
          }
        }
      }
    },
    "/accounts/{adAccountId}": {
      "patch": {
        "summary": "Toggle ad account active/inactive",
        "security": [
          {
            "serviceKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string"
            },
            "required": true,
            "name": "adAccountId",
            "in": "path"
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/PatchAccountBody"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Updated ad account",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AdAccountResponse"
                }
              }
            }
          },
          "404": {
            "description": "Account not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/accounts/{adAccountId}/sync": {
      "post": {
        "summary": "Re-sync ad account metadata from Meta",
        "security": [
          {
            "serviceKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string"
            },
            "required": true,
            "name": "adAccountId",
            "in": "path"
          }
        ],
        "responses": {
          "200": {
            "description": "Synced ad account",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AdAccountResponse"
                }
              }
            }
          },
          "404": {
            "description": "Account not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/insights": {
      "get": {
        "summary": "Get ad performance insights",
        "security": [
          {
            "serviceKeyAuth": []
          }
        ],
        "parameters": [
          {
            "schema": {
              "type": "string",
              "minLength": 1
            },
            "required": true,
            "name": "adAccountId",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "minLength": 1
            },
            "required": true,
            "name": "appId",
            "in": "query"
          },
          {
            "schema": {
              "type": "string"
            },
            "required": false,
            "name": "clerkOrgId",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "enum": [
                "account",
                "campaign",
                "adset",
                "ad"
              ],
              "default": "campaign"
            },
            "required": false,
            "name": "level",
            "in": "query"
          },
          {
            "schema": {
              "type": "string"
            },
            "required": false,
            "name": "objectId",
            "in": "query"
          },
          {
            "schema": {
              "type": "string",
              "enum": [
                "today",
                "yesterday",
                "last_7d",
                "last_14d",
                "last_30d",
                "this_month",
                "last_month",
                "this_quarter",
                "last_3d",
                "maximum"
              ]
            },
            "required": false,
            "name": "datePreset",
            "in": "query"
          },
          {
            "schema": {
              "type": "string"
            },
            "required": false,
            "name": "since",
            "in": "query"
          },
          {
            "schema": {
              "type": "string"
            },
            "required": false,
            "name": "until",
            "in": "query"
          },
          {
            "schema": {
              "type": "string"
            },
            "required": false,
            "name": "timeIncrement",
            "in": "query"
          },
          {
            "schema": {
              "type": "string"
            },
            "required": false,
            "name": "breakdowns",
            "in": "query"
          },
          {
            "schema": {
              "type": "string"
            },
            "required": false,
            "name": "fields",
            "in": "query"
          },
          {
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 5000,
              "default": 500
            },
            "required": false,
            "name": "limit",
            "in": "query"
          },
          {
            "schema": {
              "type": "string"
            },
            "required": false,
            "name": "after",
            "in": "query"
          }
        ],
        "responses": {
          "200": {
            "description": "Insights data",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/InsightsResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid request or breakdown combination",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/webhooks/meta": {
      "get": {
        "summary": "Meta webhook verification",
        "responses": {
          "200": {
            "description": "Challenge response"
          },
          "403": {
            "description": "Verification failed"
          }
        }
      },
      "post": {
        "summary": "Receive Meta webhook events",
        "responses": {
          "200": {
            "description": "Event received"
          }
        }
      }
    }
  }
}